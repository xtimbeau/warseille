---
  author:
    - name: Maxime Parodi
    - name: Xavier Timbeau 
    - name: Scotia Hille
---

```{r init, include=FALSE}
source("init.R")
version <- "1.1"
```

# Déplacements pour le motif commerce

## Proposition de méthode

L'évaluation des flux effectifs de mobilité professionnelle quotidienne repose sur la disponibilité d'une matrice origine destination très riche, disponible pour chaque année de recensement au niveau intercommunal, décrivant donc les flux de mobilité professionnelle quotidienne usuelle[^1] pour toute la France. Cette information est également disponible pour les mobilités scolaires. En revanche, pour les autres motifs de déplacement, on ne dispose pas d'un équivalent.

[^1]: Et donc sans information de fréquence.

En particulier, le motif commerce est plus complexe à appréhender parce que les lieux de commerces sont nombreux, bien plus nombreux que les lieux d'étude ou de travail. Or le motif commerce est un élément important des mobilités. Le @tbl-emp donne les valeurs agrégées moyenne pour un adulte en France hors Ile de France. Le motif "courses" représente 15% des kilomètres parcourus.

```{r}
#| label: tbl-emp
#| tbl-cap: Enquête mobilité des personnes 2019

bd_read("EMP2019_AA3") |> pluck(1)

```

L'enquête EMC^2^ donne une information construite sur le même schéma d'enquête que l'enquête mobilité nationale. On peut donc la comparer avec l'enquête nationale. Le @tbl-emc2 est construit comme pour l'EMP. Ce tableau est encore en construction, et nous devons affiner l'utilisation des pondérations. D'autre part, il ne concerne que les jours de semaine, nous n'avons pas intégré la base pour les week-ends. D'autres vérifications sont nécessaires. A ce stade, notre exploitation de l'EMC^2^ montre moins de kilomètres parcourus dans la métropole d'Aix Marseille Provence.

```{r}
#| label: tbl-emc2
#| tbl-cap: Enquête certifiée CEREMA (EMC^2^), Aix Marseille Provence

bd_read("EMP_Marseille_AA3") |> pluck(1)

```

L'enquête mobilité certifiée CEREMA (EMC^2^) délivre une information de location assez fine. Elle correspond peu ou prou à la définition de l'IRIS [@fig-subemc2]. Cette information permet donc pour d'autres motifs que le motif professionnel de construire une matrice origine destination, c'est-à-dire une information comparable à la donnée du recensement MOPBRO. Il existe cependant une nuance importante, l'EMC^2^ repose sur un échantillon représentatif mais pas exhaustif. Or, pour construire une matrice origine destination détaillée au niveau le plus fin, il faudrait un échantillon bien plus important. En revanche pour des découpages moins fins (14 zones comme dans le découpage D10 AOTU) ou encore des découpages "fonctionnels", reposant sur la caractérisation des zones par la surface de commerce. C'est sur cette base que nous proposons d'ajuster un modèle de trajets effectifs semblable à MEAPS pour les mobilités professionnelles.

```{r}
#| label: fig-subemc2
#| fig-cap: "Subdivisions de l'EMC^2^"
tmap_mode("view")
tmap_options(check.and.fix = TRUE)
bd_read("Tmap zone de l'enquete")

```

## Construction d'un indicateur de commerce

### sources de données

La première étape est d'identifier les opportunités. Une des difficultés est la versalité des motifs commerciaux associés à la grande quantité de commerces disponibles sur le territoire. Nous proposons ici d’agréger les surfaces commerciales pour chaque carreau en distinguant 4 grandes catégories de commerce. Ces catégories reprennent, avec réinterprétation, le travail réalisé par l'AUPA[^2].\
Notre source principale est celle des fichiers fonciers. Elle donne une information fine sur les secteurs utilisateur du local (code NAF à 5 caractères pour l'entreprise utilisatrice) dans lequel on peut distinguer un commerce de chaussure d'une pharmacie, une supérette d'une grande surface alimentaire.nt des couches agrégées de commerces pour des types de ménages identifiés. Elle permet d'associer au commerce une surface (variable `sprincp` des fichiers fonciers).

[^2]: Merci à Théo Shayer, Ludovic Verre et Luc Garnier pour nous avoir partagé leur méthodologie.

Nous classons les commerces en 4 catégories : alimentaire, commerces (non alimentaires), sorties, santé humaine.

La classificaiton est indiquée dans le @tbl-classification. Par rapport aux choix de l'AUPA, nous avons considéré que les pharmacies étaient des commerces "ordinaires" et limité la notion de santé humaine aux cabinets médicaux (généralistes, spécialistes ou dentistes) en excluant les hôpitaux. Comme nous tenons compte de la surface, les hôpîtaux auraient dominé cette catégorie sans que cela ait vraiment du sens. Le but recherché est de quantifier l'usage habituel de la santé et donc la proximité de services de santé.

```{r}
#| label: tbl-classification
#| tbl-cap: Classification des commerces en catégories fonctionnelles

library(gt)
library(tidyverse)
readxl::read_xlsx("commerces/classification.xlsx") |> 
  mutate(`Catégorie` = toupper(`Catégorie`)) |> 
  group_by(Classification) |> 
  gt() |>  
  gt::sub_missing() |> 
  cols_label(`Catégorie` = "")
```

Les fichiers fonciers, bien que construit pour la perception d'une taxe comportent parfois des informations curieuses, pouvant laisser croire à un bruit. Par exemple, certaines surfaces commerciales sont très importantes (il existe des supérettes de plus de 100 000 m²) ou la notion de surface principale est parfois ambigue (comme le montre celle qui est retenue pour les campings). Nous utilisons donc avec prudence cette donnée en la limitant suivant certaines catégories. Ainsi, le @tbl-cap donne les intervalles dans lesquels sont contraintes les surfaces principales.

```{r}
#| label: tbl-cap
#| tbl-cap: Limites de surface

bd_read("les_surfaces") |> 
  gt() |> 
  cols_label(NAF_TXT = "", cconac = "Code NAF", smin = "Minimum (m²)", smax = "Maximum (m²)") |> 
  cols_hide(surf) 

```

Les sources alternatives aux fichiers fonciers sont

1.  la base des équipements. A notre connaissance, depuis le changement de nomenclature dans la base des fichiers fonciers de 2018, les fichiers fonciers excluent les entités juridiques qui n'ont pas d'activité et cette modification rapproche la source équipement de la source fichiers fonciers.
2.  Des enquêtes sur les commerces, comme l'enquête BD COM 2020 à Paris, présentée par l'[APUR](https://www.apur.org/dataviz/commerces-paris/). Ce type d'enquête est assez robuste car il repose sur des observations directes des surfaces commerciales ouvertes au public. En revanche, le champ géographique est habituellement trop limité (ici uniquement la commune de Paris). Nous n'avons pas connaissance d'une enquête comparable pour l’agglomération AMP.
3.  La base de données OpenStreetMap, en accès libre. Réalisée à partir d'une information participative, elle constitue une alternative simple à mobiliser[^3]. Dans nos analyses préliminaires, elle recoupe assez bien les fichiers fonciers tout en illustrant certains problèmes d'identification (par exemple, des établissements considérés comme "supermarchés" dans les fichiers fonciers sont répertoriés comme épicerie dans OSM et les implémentations (taille du pâté de maisons) donnent plutôt raison à OSM. C'est pour limiter cet effet que nous avons cappé les surfaces.

[^3]: Elle contient des informations également sur les trafics illégaux (stupéfiants), ce qui peut être intéressant à exploiter.

Nous tenons compte enfin de la diversité des commerces à partir de l'information des fichiers fonciers. Par exemple, pour la catégorie fonctionnelle commerce nous agrégeons les surfaces commerciales, en les multipliant par un indice de diversité qui est minimum lorsqu'une seule espèce de commerce est présente et maximal lorsque toutes les espèces sont représentées. Ce type d'indicateur est souvent utilisé en écologie. Il permet donc de donner plus de poids à un bouquet diversifié de commerce totalisant 1 000 m² plutôt qu'à un unique commerce (un garage disons) de 1 000 m².

### Indicateur

::::: {#fig-surfeq_map }
:::: panel-tabset
## Carte statique

```{r}
#| fig-asp: 1.6
library(sf)

data <- bd_read("vqh_alim") |>
  mutate(type = "Alimentation") |> 
  bind_rows(bd_read("vqh_comm") |> mutate(type = "Autres commerces")) |> 
  filter(!is.na(fromidINS), se > 0) |> 
  mutate(lse = log(se)) |> 
  r3035::sidINS2sf(idINS = "fromidINS") |>
  group_by(type) |> 
  mutate(lse_q = santoku::chop_quantiles(lse, probs = 0:10/10)) |> 
  ungroup()  


ggplot() +
  bd_read("decor_carte") +
  geom_sf(
    data= data,
    mapping= aes(fill = lse), col=NA) + 
  paletteer::scale_fill_paletteer_c("grDevices::Heat", direction = -1)+
  theme_ofce_void() +
  facet_wrap(vars(type), nrow = 2) +
  theme(legend.position = "bottom", legend.key.height = unit(6, "pt")) +
  labs(caption=glue("*Source* : C200, OSM, Fichiers fonciers, version {version}"))
```

::: column-margin
```{r dnwstat}
download_this(
  data |> 
    st_drop_geometry() |> 
    mutate(fromidINS = r3035::expand_idINS(fromidINS)),
  icon = "fa fa-download",
  class = "dbtn",
  button_label = "données Commerces au carreau, résidents", 
  output_name = glue("commerces_idINS_pdvR_MetAMP.{version}"))
```
:::

## Alimentation (interactif)

::: column-screen
```{r }

library(colourvalues)
pal <- "plasma"
color_txxk <- function(x, min = 0, max = 11, palette = pal, rev=FALSE) {
  if(rev) {
    color_values(c(min, max, trim(x, min, max)), palette=palette) |> tail(-2)
  } else {
  color_values(c(min, max, trim(max - x + min, min, max)), palette=palette) |> tail(-2)  
  }
}
legend <- color_values(0:11, palette = pal, summary=TRUE, n_summaries=5)
le <- legend_element(as.integer(legend$summary_values), rev(legend$summary_colours), "fill", "gradient", "se") |> 
  mapdeck_legend()

data |>
  filter(type == "Alimentation") |> 
  transmute(
    ind, div, s, se, lse,
    lidINS= r3035::expand_idINS(fromidINS),
    tooltip=glue::glue(
    "<b>{type}</b><br>
    idINS:{lidINS} {ind} individus<br>
     s: {round(s)}<br>
     div: {round(s,2)}<br>
     se: {round(se, 2)}"),
    cse = color_txxk(lse)) |>
  st_transform(4326) |>
  mapdeck(style = style,
          height = "60vh",
          width = "100%") |>
  add_polygon(fill_colour = "cse",
              elevation_scale = 2,
              legend = le,
              tooltip = "tooltip") |>
  mapdeck_view(location = centre, zoom = 9, pitch = 0, bearing = 0)
```
:::
## Aurtes commerces (interactif)

::: column-screen
```{r }

data |>
  filter(type == "Autres commerces") |> 
  transmute(
    ind, div, s, se, lse,
    lidINS= r3035::expand_idINS(fromidINS),
    tooltip=glue::glue(
    "<b>{type}</b><br>
    idINS:{lidINS} {ind} individus<br>
     s: {round(s)}<br>
     div: {round(s,2)}<br>
     se: {round(se, 2)}"),
    cse = color_txxk(lse)) |>
  st_transform(4326) |>
  mapdeck(style = style,
          height = "60vh",
          width = "100%") |>
  add_polygon(fill_colour = "cse",
              elevation_scale = 2,
              legend = le,
              tooltip = "tooltip") |>
  mapdeck_view(location = centre, zoom = 9, pitch = 0, bearing = 0)
```
:::
::::
:::::

```{r}
#| label: fig-corrcomm
#| fig-cap: "Corrélation entre Alimentation et autres commerces"
#| fig-asp: 1

data |> 
  st_drop_geometry() |> 
  select(ind, se, type, fromidINS) |> 
  mutate(type = factor(type, label=c("alim", "comm"))) |> 
  pivot_wider(id_cols = c(fromidINS, ind), names_from = type, values_from = se) |> 
  ggplot() +
  geom_hex(aes(x = alim, y=comm, weight = ind)) +
  coord_equal() +
  scale_x_log10(name = "surface équivalente des commerces alimentaires") +
  scale_y_log10(name = "surface équivalente des autres commerces") +
  scale_fill_gradient(low = "white", high = "steelblue4", name = "individus")+
  theme_ofce(legend.position = c(0.05, 0.95),
             legend.justification = c(0,1),
             legend.key.width = unit(36, "pt"))
```
:::: {#fig-denscom}
:::: {.panel-tabset}

## Alimentation

```{r}
#| fig-asp: 1

data |> 
  st_drop_geometry() |> 
  select(ind, se, type, fromidINS) |> 
  mutate(type = factor(type, label=c("alim", "comm"))) |> 
  pivot_wider(id_cols = c(fromidINS, ind), names_from = type, values_from = se) |> 
  ggplot() +
  geom_hex(aes(x = ind, y=alim, weight = ind)) +
  scale_x_log10(name = "densité")+
  scale_y_log10(name = "surface équivalente, alimentation", limits = c(1, 1e+6))+
  scale_fill_gradient(low = "white", high = "purple4")+
  theme_ofce(legend.position = c(0.05, 0.95),
             legend.justification = c(0,1),
             legend.key.width = unit(24, "pt"))
```
## Autres commerces

```{r}
#| fig-asp: 1

data |> 
  st_drop_geometry() |> 
  select(ind, se, type, fromidINS) |> 
  mutate(type = factor(type, label=c("alim", "comm"))) |> 
  pivot_wider(id_cols = c(fromidINS, ind), names_from = type, values_from = se) |> 
  ggplot() +
  geom_hex(aes(x = ind, y=comm, weight = ind)) +
  scale_x_log10(name = "densité")+
  scale_y_log10(name = "surface équivalente, autres commerces", limits = c(1, 1e+6))+
  scale_fill_gradient(low = "white", high = "yellow4")+
  theme_ofce(legend.position = c(0.05, 0.95),
             legend.justification = c(0,1),
             legend.key.width = unit(24, "pt"))
```
::::
Lien densité accessibilité aux commerces

::::
### Indicateur et EMC^2^

On injecte l'indicateur de commerce alimentaire calculé dans les zones de résidence de l'EMC^2 AMP. On peut alors confronter les distances parcourues en voiture à la valeur moyenne de l'indicateur sur la zone. Le graphique indique une nette corrélation négative.

```{r}
#| label: fig-emc2alim
#| fig-cap: Distance parcourue par décile d'accessibilité aux commerces alimentaires
ind_emc2 <- bd_read("ind_emc2")

ind_emc2 <- ind_emc2 |> 
  mutate(lse_q = santoku::chop_deciles(log(se))) 

ggplot(ind_emc2 |> filter(!is.na(lse_q), n>10))+
  aes(x = lse_q, y = d_car) +
  geom_boxplot(outliers = FALSE) + 
  theme_ofce()

```

La régression suivante confirme ce résultat :

```{r}
lm( log(d_car) ~ log(se), data = ind_emc2 |> filter(!is.na(lse_q), n>10, d_car >0)) |> summary()
```



## Références bibliographiques {.unnumbered}

::: {#refs}
:::
